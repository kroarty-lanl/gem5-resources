---
title: MPI Tests
tags:
    - x86
    - fullsystem
permalink: resources/mpi-test
shortdoc: >
    Disk image to run some simple MPI tests to verify they work
license: BSD-3-Clause
---

This document provides instructions to create a disk image that contains simple MPI applications to verify MPI works.

```
mpi-tests/
    ├── disk-image
    │   ├── build.sh                     # The script for downloading packer and building the disk image
    │   ├── shared                       # Auxiliary files for disk creation
    │   │   ├── meta-data
    │   │   ├── serial-getty@.service
    │   │   └── user-data                # If behind a proxy, set it in this file
    │   ├── mpi-test 
    │   │   ├── mpi-tests/      	 # Directory containing test source code
    │   │   ├── gem5-init.sh             # Executes a user-provided script in simulated guest
    │   │   ├── m5-download.sh           # Script to build m5 and download the m5ops headers
    │   │   ├── m5-setup.sh              # Misc setup to boot faster and set up m5
    │   │   ├── mpi-test-install.sh      # Script to build spatter
    │   │   └── mpi-test.json            # Packer script to build the disk image
    │   └── mpi-test-image               # Autogenerated directory, contains the disk image after building
    ├── LICENSE                          # LANL license
    └── README.md                        # This README file
```

## Disk Image

### NOTE: If you are behind a proxy, set it in `disk-image/shared/user-data` before building

Assuming that you are in the `src/mpi-test/` directory (the directory containing this README), execute the following:

```sh
cd disk-image
./build.sh          # the script downloading packer binary and building the disk image
```

Once this process succeeds, the created disk image can be found on `mpi-test/mpi-test-image/mpi-test`.

## Using the disk image

The disk image builds multiple tests, located at:

```
/home/gem5/mpi-tests/hello_mpi_c
/home/gem5/mpi-tests/hello_mpi_f90
/home/gem5/mpi-tests/send_recv_c
/home/gem5/mpi-tests/send_recv_f90
```

## Simulating the tests using a sample script

This uses the sample KVM config that's provided in another git repo (link to be placed)

Assumes directory structure:
```
.
├── gem5
├── gem5-resources
└── gem5-configs
```

To build gem5:

```sh
#If you haven't downloaded gem5 yet
git clone https://github.com/gem5/gem5.git

cd gem5
scons -j$(nproc) build/X86/gem5.opt
```

To run a simple hello world example in gem5:

```
gem5/build/X86/gem5.opt \
    gem5-configs/simple-kvm-config.py \
    --image gem5-resources/src/mpi-test/disk-image/mpi-test/mpi-test
    --command="su - gem5 -c 'cd mpi-tests; mpirun -n 2 ./hello_world_c'"
```

## Using Charliecloud with gem5

LANL uses Charliecloud containers as a way to run applications in a container while
minimizing the permissions the user gets when running in a container.

To build a Charliecloud image to use gem5 with: (Dockerfile will be in same repo as the configs)
```sh
module load charliecloud
ch-image build -t gem5 --force fakeroot .
# Image is now stored as a tarball so you don't have to build it every time
ch-convert gem5 gem5.tar.gz

# To "activate" the image:
ch-convert gem5.tar.gz /var/tmp/gem5
```

Building gem5 using charliecloud:

```sh
ch-run -w -b </home/or/scratch/dir>:</home/or/scratch/dir> -c </path/to/gem5/dir> /var/tmp/gem5 -- \
    scons -j$(nproc) build/X86/gem5.opt
```

Running Spatter example using charliecloud:
```sh
# /path/to/above/dir is the path to the directory with the structure listed above
ch-run -w -b </home/or/scratch/dir>:</home/or/scratch/dir> -c </path/to/above/dir> /var/tmp/gem5 -- \
    gem5/build/X86/gem5.opt \
        gem5-configs/simple-kvm-config.py \
        --image gem5-resources/src/mpi-test/disk-image/mpi-test/mpi-test
        --command="su - gem5 -c 'cd mpi-tests; mpirun -n 2 ./hello_world_c'"
```
